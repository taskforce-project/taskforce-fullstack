# ü§ñ Instructions Claude Sonnet 4.5 - Projet Taskforce

> **Fichier de configuration pour l'IA Claude Sonnet 4.5**  
> √Ä lire AVANT toute intervention sur le projet

---

## üéØ R√®gles G√©n√©rales

### ‚ö†Ô∏è IMP√âRATIF - Ne JAMAIS faire sans demander

1. **NE JAMAIS lancer de commandes** sans confirmation explicite de l'utilisateur
2. **NE JAMAIS utiliser `Start-Sleep` ou attentes** - l'utilisateur sait quand les services sont pr√™ts
3. **NE JAMAIS cr√©er de fichiers markdown de r√©sum√©** sauf demande explicite
4. **TOUJOURS v√©rifier avant d'agir** - l'utilisateur demande de v√©rifier ‚â† lancer

### üí¨ Communication

- **R√©ponses courtes et directes** - l'utilisateur est d√©veloppeur, pas besoin d'explications infantilisantes
- **Pas de phrases de politesse excessives** - rester professionnel mais concis
- **Ne pas r√©p√©ter ce que l'utilisateur vient de dire** - il le sait d√©j√†
- **Pas d'emojis excessifs** - maximum 2-3 par message
- **Utiliser le fran√ßais** - sauf demande explicite pour l'anglais
- **Les propositions sont les bienvenues, elles doivent √™tre claires et pr√©cises** - √©viter les ambigu√Øt√©s

### üîç Workflow de travail

1. **Demande de v√©rification** ‚Üí LIRE les fichiers concern√©s, R√âSUMER les incoh√©rences trouv√©es
2. **Demande de correction** ‚Üí CORRIGER directement avec les outils appropri√©s
3. **Doute sur l'intention** ‚Üí DEMANDER confirmation avant d'agir

---

## üìÅ Structure du Projet

### Monorepo Organisation

```
taskforce-fullstack/
‚îú‚îÄ‚îÄ backend/tf-api/          # Spring Boot API (Java 21)
‚îú‚îÄ‚îÄ frontend/                # Next.js 15 (TypeScript)
‚îú‚îÄ‚îÄ landing-page/            # Astro (site vitrine)
‚îú‚îÄ‚îÄ keycloak/                # Configuration Keycloak
‚îú‚îÄ‚îÄ scripts/                 # Scripts de d√©ploiement
‚îú‚îÄ‚îÄ .env.dev                 # Variables d'environnement DEV (Docker)
‚îî‚îÄ‚îÄ docker-compose.dev.yml   # Orchestration Docker DEV
```

### Environnements

- **DEV** : `docker-compose.dev.yml`, `.env.dev`, `application-dev.yml`, `realm-dev/`
- **PROD** : `docker-compose.prod.yml`, `.env.prod`, `application-prod.yml`, `realm-prod/`

‚ö†Ô∏è **Coh√©rence OBLIGATOIRE** : Tout changement doit √™tre v√©rifi√© dans TOUS les fichiers de l'environnement concern√©

---

## üîÄ Git Workflow & Commits

### Branches Principales

- **`main`** : Production stable (`v1.0.0`)
- **`dev`** : D√©veloppement avec Release Candidates (`v1.0.0-rc1`)

### Branches de Travail

| Type | Nomenclature | Depuis |
|------|--------------|--------|
| Feature | `feature/nom-feature` | `dev` |
| Fix | `fix/nom-bug` | `dev` |
| Hotfix | `hotfix/nom-fix` | `main` |

### Conventions de Commits (OBLIGATOIRE)

**Format** : `<type>(<scope>): <description>`

#### Types de Commits

| Type | Usage | Exemple |
|------|-------|---------|
| `feat` | Nouvelle fonctionnalit√© | `feat(auth): add 3-step registration flow` |
| `fix` | Correction de bug | `fix(api): correct port configuration from 8081 to 8080` |
| `refactor` | Refactoring sans changement fonctionnel | `refactor(auth): split registration into 3 services` |
| `docs` | Documentation uniquement | `docs(readme): update setup instructions` |
| `style` | Formatage, indentation | `style(backend): fix code formatting` |
| `test` | Ajout/modification de tests | `test(auth): add unit tests for selectPlan` |
| `chore` | T√¢ches de maintenance | `chore(deps): update Spring Boot to 3.4.2` |
| `ci` | CI/CD | `ci(docker): optimize backend image build` |
| `perf` | Optimisation performance | `perf(db): add index on otp_verification.email` |
| `build` | Modifications de build | `build(frontend): update webpack config` |
| `config` | Modifications de configuration | `config(keycloak): update realm settings for dev` |

#### Scopes Recommand√©s

- **Backend** : `api`, `auth`, `user`, `subscription`, `db`, `security`
- **Frontend** : `ui`, `auth`, `dashboard`, `components`, `api-client`
- **Infra** : `docker`, `keycloak`, `postgres`, `nginx`
- **Global** : `config`, `env`, `deps`

#### Exemples de Commits Valides

```bash
# Nouvelle fonctionnalit√©
git commit -m "feat(auth): implement 3-step registration with plan selection"

# Correction de bug
git commit -m "fix(docker): correct backend port from 8081 to 8080"

# Refactoring
git commit -m "refactor(auth): extract plan storage to OtpVerification table"

# Configuration
git commit -m "chore(config): add planType column to otp_verification"

# Documentation
git commit -m "docs(api): document /select-plan endpoint"
```

#### ‚ùå Exemples √† √âviter

```bash
# Trop vague
git commit -m "fix stuff"
git commit -m "update"

# Pas de type
git commit -m "corrected the port"

# Type incorrect
git commit -m "feat: fix bug"  # fix ‚â† feat
```

---

## üè∑Ô∏è Pull Requests & Labels

### Labels Obligatoires (UN SEUL)

Chaque PR **DOIT** avoir exactement **UN** label de version :

- `release:major` - Breaking changes (`v1.0.0` ‚Üí `v2.0.0`)
- `release:minor` - Nouvelles features (`v1.0.0` ‚Üí `v1.1.0`)
- `release:patch` - Bug fixes (`v1.0.0` ‚Üí `v1.0.1`)

### Labels Optionnels

**Type** :
- `type:feature`, `type:bugfix`, `type:refactor`, `type:test`, `type:ci/cd`

**Composants** :
- `backend`, `frontend`, `database`, `infra`

**Priorit√©** :
- `priority:critical`, `priority:high`, `priority:medium`, `priority:low`

### Titre de PR

Suivre les m√™mes conventions que les commits :

```
feat(auth): implement 3-step registration flow
fix(docker): correct API URL for frontend container
refactor(auth): extract plan selection logic
```

---

## üèóÔ∏è Architecture & Conventions

### Backend (Spring Boot)

- **Port** : `8080`
- **Context Path** : `/api`
- **Profile DEV** : `application-dev.yml`
- **Base de donn√©es** : PostgreSQL 16
- **Auth** : Keycloak avec OAuth2/OIDC
- **Migrations** : Flyway (`V1__`, `V2__`, etc.)

#### Conventions Java

- **Packages** : `com.taskforce.tf_api.<module>.<type>`
- **DTOs** : `*Request.java`, `*Response.java`
- **Services** : Logique m√©tier, pas de `@Transactional` partout
- **Controllers** : REST API, validation `@Valid`, retourner `ApiResponse<T>`

#### Architecture Professionnelle

‚ö†Ô∏è **JAMAIS de champs optionnels "par flemme"** - Si un champ n'est pas disponible √† une √©tape, cr√©er des endpoints s√©par√©s et du stockage temporaire appropri√©

**Exemple** : Inscription en 3 √©tapes
```
POST /auth/register       ‚Üí Step 1: Cr√©e compte Keycloak + OTP
POST /auth/select-plan    ‚Üí Step 2: Stocke plan dans otp_verification
POST /auth/verify-otp     ‚Üí Step 3: R√©cup√®re plan + cr√©e user en DB
```

### Frontend (Next.js)

- **Port** : `3000`
- **Framework** : Next.js 15 (App Router)
- **UI** : Shadcn/UI + Tailwind CSS
- **API Client** : Axios avec intercepteurs JWT

#### Conventions TypeScript

- **Pas de `any`** - Toujours typer correctement
- **Interfaces** : `PascalCase` (ex: `AuthResponse`, `UserProfile`)
- **Composants** : PascalCase (ex: `RegisterForm.tsx`)
- **Fonctions utilitaires** : camelCase (ex: `getErrorMessage`)

### Docker

#### Services (docker-compose.dev.yml)

| Service | Port H√¥te | Port Container | URL |
|---------|-----------|----------------|-----|
| postgres | 5432 | 5432 | `localhost:5432` |
| keycloak | 8180 | 8080 | `http://localhost:8180` |
| backend | 8080 | 8080 | `http://localhost:8080/api` |
| frontend | 3000 | 3000 | `http://localhost:3000` |
| pgadmin | 5050 | 80 | `http://localhost:5050` |

#### Variables d'Environnement

**R√®gle d'or** : Dans Docker, les services communiquent via **noms de services**, pas `localhost`

```yaml
# Frontend dans Docker
NEXT_PUBLIC_API_URL: http://backend:8080/api  # ‚úÖ Nom du service

# Frontend hors Docker (dev local)
NEXT_PUBLIC_API_URL: http://localhost:8080/api  # ‚úÖ localhost
```

---

## ‚úÖ Checklist de V√©rification

Avant toute modification, v√©rifier la **coh√©rence** dans :

### Pour un changement de configuration DEV

- [ ] `.env.dev` (variables Docker)
- [ ] `frontend/.env.local` (dev local hors Docker)
- [ ] `docker-compose.dev.yml` (services + ports + env override)
- [ ] `backend/tf-api/src/main/resources/application-dev.yml`
- [ ] `keycloak/realms/dev/taskforce-dev-realm.json`

### Pour un changement de code Backend

- [ ] DTO cr√©√©s/modifi√©s (`*Request.java`, `*Response.java`)
- [ ] Service m√©tier (`*Service.java`)
- [ ] Controller REST (`*Controller.java`)
- [ ] Repository si n√©cessaire (`*Repository.java`)
- [ ] Migration Flyway si changement DB (`V{n}__description.sql`)
- [ ] Tests unitaires (optionnel mais recommand√©)

### Pour un changement de code Frontend

- [ ] Types TypeScript (interfaces)
- [ ] Service API (`lib/api/*-service.ts`)
- [ ] Composant UI (`components/**/*.tsx`)
- [ ] Validation Zod si formulaire (`lib/validations/`)

---

## üö´ Anti-Patterns √† √âviter

### ‚ùå Ne JAMAIS faire

1. **Champs optionnels par simplicit√©** - D√©couper en endpoints s√©par√©s
2. **Hardcoder des valeurs** - Utiliser variables d'environnement
3. **M√©langer `localhost` et noms de services Docker** - V√©rifier le contexte
4. **Ignorer les migrations Flyway** - Toujours cr√©er une migration pour les changements DB
5. **Commit avec message vague** - Respecter les conventions
6. **Modifier application.yml au lieu de application-dev.yml** - Attention √† l'environnement
7. **Cr√©er des PR sans label `release:*`** - PR sera bloqu√©e

### ‚úÖ Bonnes Pratiques

1. **Lire d'abord, agir ensuite** - Comprendre le contexte avant de modifier
2. **V√©rifier la coh√©rence multi-fichiers** - Un changement peut impacter plusieurs configs
3. **Typage strict** - TypeScript + Java avec types explicites
4. **Architecture par couches** - Controller ‚Üí Service ‚Üí Repository
5. **Nommage explicite** - `selectPlan()` plut√¥t que `step2()`
6. **Tests si possible** - Au moins les endpoints critiques

---

## üìñ Documentation de R√©f√©rence

- **Git Workflow** : `taskforce-docs/developpeur/git-workflow/`
- **Architecture** : `taskforce-docs/technique/Architecture.md`
- **API Spec** : `taskforce-fullstack/frontend/API_SPECIFICATION.md`
- **Setup Dev** : `taskforce-docs/developpeur/quickstart/`

---

## üéØ R√©sum√© - √Ä Retenir

1. ‚úÖ **V√©rifier avant d'agir** - Lire les fichiers concern√©s
2. ‚úÖ **Coh√©rence multi-fichiers** - V√©rifier tous les fichiers de l'environnement
3. ‚úÖ **Conventions de commits strictes** - `type(scope): description`
4. ‚úÖ **Architecture professionnelle** - Pas de raccourcis "par flemme"
5. ‚úÖ **Docker networking** - Services = noms, localhost = h√¥te
6. ‚ùå **Ne JAMAIS lancer sans demander** - L'utilisateur d√©cide quand ex√©cuter
7. ‚ùå **Ne JAMAIS utiliser Start-Sleep** - Inutile et contre-productif

---

**Derni√®re mise √† jour** : 2026-02-01  
**Version** : 1.0.0
