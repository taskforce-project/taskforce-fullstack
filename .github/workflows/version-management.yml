name: üè∑Ô∏è Version Management

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]
    branches:
      - dev
      - main

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-version-label:
    name: ‚úÖ Validate Release Label
    runs-on: ubuntu-latest
    steps:
      - name: Check for release label
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            const releaseLabels = labels.filter(l => l.startsWith('release:'));
            
            if (releaseLabels.length === 0) {
              core.setFailed('‚ùå Missing release label! Add one of: release:major, release:minor, or release:patch');
              return;
            }
            
            if (releaseLabels.length > 1) {
              core.setFailed('‚ùå Multiple release labels found! Use only ONE: ' + releaseLabels.join(', '));
              return;
            }
            
            core.info('‚úÖ Valid release label: ' + releaseLabels[0]);

  calculate-next-version:
    name: üî¢ Calculate Next Version
    runs-on: ubuntu-latest
    needs: validate-version-label
    outputs:
      next_version: ${{ steps.calc.outputs.next_version }}
      current_version: ${{ steps.calc.outputs.current_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: latest-tag
        run: |
          # R√©cup√©rer le dernier tag selon la branche cible
          if [[ "${{ github.base_ref }}" == "dev" ]]; then
            LATEST=$(git tag -l "v*-rc*" --sort=-v:refname | head -n1)
          else
            LATEST=$(git tag -l "v*" --sort=-v:refname | grep -v "rc" | head -n1)
          fi
          
          # Si aucun tag, commencer √† v0.1.0
          if [ -z "$LATEST" ]; then
            if [[ "${{ github.base_ref }}" == "dev" ]]; then
              LATEST="v0.1.0-rc0"
            else
              LATEST="v0.0.0"
            fi
          fi
          
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "üìå Latest tag: $LATEST"

      - name: Calculate next version
        id: calc
        uses: actions/github-script@v7
        with:
          script: |
            const latestTag = '${{ steps.latest-tag.outputs.latest }}';
            const baseBranch = context.payload.pull_request.base.ref;
            const labels = context.payload.pull_request.labels.map(l => l.name);
            
            // Extraire la version actuelle
            let match = latestTag.match(/v(\d+)\.(\d+)\.(\d+)(-rc(\d+))?/);
            if (!match) {
              core.setFailed('Invalid tag format: ' + latestTag);
              return;
            }
            
            let [_, major, minor, patch, __, rc] = match;
            major = parseInt(major);
            minor = parseInt(minor);
            patch = parseInt(patch);
            rc = rc ? parseInt(rc) : 0;
            
            // D√©terminer le type de release
            const releaseType = labels.find(l => l.startsWith('release:'))?.split(':')[1];
            
            let nextVersion;
            
            if (baseBranch === 'dev') {
              // PR vers dev : incr√©menter RC ou version selon label
              if (labels.includes('release:major')) {
                major += 1;
                minor = 0;
                patch = 0;
                rc = 1;
              } else if (labels.includes('release:minor')) {
                minor += 1;
                patch = 0;
                rc = 1;
              } else if (labels.includes('release:patch')) {
                patch += 1;
                rc = 1;
              } else {
                // M√™me version, incr√©menter RC
                rc += 1;
              }
              nextVersion = `v${major}.${minor}.${patch}-rc${rc}`;
            } else {
              // PR vers main : enlever RC et incr√©menter selon label
              if (labels.includes('release:major')) {
                major += 1;
                minor = 0;
                patch = 0;
              } else if (labels.includes('release:minor')) {
                minor += 1;
                patch = 0;
              } else {
                patch += 1;
              }
              nextVersion = `v${major}.${minor}.${patch}`;
            }
            
            core.setOutput('next_version', nextVersion);
            core.setOutput('current_version', latestTag);
            core.info('üéØ Next version: ' + nextVersion);

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const nextVersion = '${{ steps.calc.outputs.next_version }}';
            const currentVersion = '${{ steps.calc.outputs.current_version }}';
            const baseBranch = context.payload.pull_request.base.ref;
            
            const comment = `## üè∑Ô∏è Version Bump Preview
            
            **Current version:** \`${currentVersion}\`  
            **Next version:** \`${nextVersion}\`  
            **Target branch:** \`${baseBranch}\`
            
            This version will be tagged automatically when the PR is merged.
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
