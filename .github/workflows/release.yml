name: ðŸš€ Release & Docker Publish

on:
  push:
    branches:
      - dev
      - main

permissions:
  contents: write
  packages: write

jobs:
  create-tag-and-publish:
    name: ðŸ“¦ Tag & Publish Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR labels
        id: pr-labels
        uses: actions/github-script@v7
        with:
          script: |
            // RÃ©cupÃ©rer le dernier commit du push
            const commit = context.payload.head_commit.id;
            
            // Trouver la PR associÃ©e
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: commit
            });
            
            if (prs.data.length === 0) {
              core.setFailed('No PR found for this commit');
              return;
            }
            
            const pr = prs.data[0];
            const labels = pr.labels.map(l => l.name);
            
            core.setOutput('labels', labels.join(','));
            core.setOutput('pr_number', pr.number);
            core.info('PR #' + pr.number + ' labels: ' + labels.join(', '));

      - name: Calculate version
        id: version
        run: |
          LABELS="${{ steps.pr-labels.outputs.labels }}"
          BRANCH="${{ github.ref_name }}"
          
          # RÃ©cupÃ©rer le dernier tag
          if [[ "$BRANCH" == "dev" ]]; then
            LATEST=$(git tag -l "v*-rc*" --sort=-v:refname | head -n1)
          else
            LATEST=$(git tag -l "v*" --sort=-v:refname | grep -v "rc" | head -n1)
          fi
          
          # Initialiser si aucun tag
          if [ -z "$LATEST" ]; then
            if [[ "$BRANCH" == "dev" ]]; then
              LATEST="v0.1.0-rc0"
            else
              LATEST="v0.0.0"
            fi
          fi
          
          # Parser la version
          if [[ $LATEST =~ v([0-9]+)\.([0-9]+)\.([0-9]+)(-rc([0-9]+))? ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            RC="${BASH_REMATCH[5]:-0}"
          else
            echo "Invalid tag format: $LATEST"
            exit 1
          fi
          
          # Calculer la nouvelle version
          if [[ "$BRANCH" == "dev" ]]; then
            if [[ "$LABELS" == *"release:major"* ]]; then
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              RC=1
            elif [[ "$LABELS" == *"release:minor"* ]]; then
              MINOR=$((MINOR + 1))
              PATCH=0
              RC=1
            elif [[ "$LABELS" == *"release:patch"* ]]; then
              PATCH=$((PATCH + 1))
              RC=1
            else
              RC=$((RC + 1))
            fi
            NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}-rc${RC}"
          else
            # main branch
            if [[ "$LABELS" == *"release:major"* ]]; then
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
            elif [[ "$LABELS" == *"release:minor"* ]]; then
              MINOR=$((MINOR + 1))
              PATCH=0
            else
              PATCH=$((PATCH + 1))
            fi
            NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          fi
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ New version: $NEW_VERSION"

      - name: Create Git Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.version }}" -m "Release ${{ steps.version.outputs.version }}"
          git push origin "${{ steps.version.outputs.version }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend/tf-api
          file: ./backend/tf-api/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/backend:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository }}/backend:latest
            ghcr.io/${{ github.repository }}/backend:sha-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/frontend:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository }}/frontend:latest
            ghcr.io/${{ github.repository }}/frontend:sha-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Landing
        uses: docker/build-push-action@v5
        with:
          context: ./landing-page
          file: ./landing-page/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/landing:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository }}/landing:latest
            ghcr.io/${{ github.repository }}/landing:sha-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.version.outputs.version }}';
            const branch = '${{ github.ref_name }}';
            const isPrerelease = version.includes('-rc');
            
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: version,
              name: version,
              body: `## ${version}\n\nReleased from \`${branch}\` branch.\n\n**Docker Images:**\n- \`ghcr.io/${{ github.repository }}/backend:${version}\`\n- \`ghcr.io/${{ github.repository }}/frontend:${version}\`\n- \`ghcr.io/${{ github.repository }}/landing:${version}\``,
              draft: false,
              prerelease: isPrerelease
            });
